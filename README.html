<html>
<head>
  <title>Winstone Servlet Container</title>
  <meta name="description" content="Winstone is a small, fast and functional java servlet v2.4 container in a single 150kb jar file"/>
  <meta name="keywords" content="servlets, servlet, jsp, java, jdk, jre, winstone, small, fast, reliable, open source, gpl, gcj, jndi, xml"/>
  <meta name="author" content="Rick Knowles"/>
  <meta name="language" content="English"/>
  <meta name="charset" content="ISO-8859-1"/>
  <meta name="MSSmartTagsPreventParsing" content="TRUE"/>
  <meta name="distribution" content="Global"/>
  <meta name="rating" content="General"/>
  <meta name="robots" content="Index, Follow"/>
  <meta name="revisit-after" content="7 Days"/>
</head>
<body>
<center><h1>Winstone Servlet Container v0.7</h1></center>

  <center><a href="http://sourceforge.net/project/showfiles.php?group_id=98922">Downloads</a></center>
  <hr width="90%" size="1" noshade="noshade"/>

<br/>
<center>
  <table border="0" width="90%">
    <tr>
      <td>
  <p>This is a beta release of the Winstone Servlet Container.  The homepage for this project is 
    at 'http://winstone.sourceforge.net'</p>

  <p>Author: Rick Knowles (contact details below)</p>

  <h2>Contents</h2>
  <h3>About:</h3>
  <ul>
    <li><a href="#whatIs">What is Winstone ?</a></li>
    <li><a href="#whyCalled">Why is it called Winstone ?</a></li>
    <li><a href="#license">License</a></li>
    <li><a href="#authorContact">Contacting the Author</a></li>
  </ul>
  <h3>Introduction:</h3>
  <ul>
    <li><a href="#using">Using Winstone</a></li>
    <li><a href="#commandLine">Command-line options</a></li>
    <li><a href="#configFile">Configuration file</a></li>
    <li><a href="#caveats">Caveats</a></li>
    <li><a href="#security">Security Warnings</a></li>
    <li><a href="#recent">Recent Additions</a></li>
  </ul>
  <h3>Usage tips:</h3>
  <ul>
    <li><a href="#xerces">Using Xerces as an XML parser (required for v2.4 webapps)</a></li>
    <li><a href="#jasper">JSPs (aka using with Jasper)</a></li>
    <li><a href="#apache">Connecting to Apache</a></li>
    <li><a href="#authRealms">Using Authentication Realms</a></li>
    <li><a href="#cluster">Cluster support</a></li>
    <li><a href="#controlPort">Control port functions/protocol</a></li>
    <li><a href="#jndi">JNDI support</a></li>
    <li><a href="#https">HTTPS support</a></li>
  </ul>
  <h3>Additional:</h3>
  <ul>
    <li><a href="#gcj">Compiling with GCJ</a></li>
  </ul>

<h2><a name="whatIs">What is Winstone ?</a></h2>

  <p>Winstone is a servlet container that was written out of a desire to provide servlet
    functionality without the bloat that full J2EE compliance introduces.</p>

  <p>It is not intended to be a completely fully functional J2EE style servlet 
    container (by this I mean supporting extraneous APIs unrelated to Servlets, such as 
    JNDI, JavaMail, EJBs, etc) - this is left to Tomcat, Jetty, Resin, JRun, Weblogic et al. </p>

  <p>Sometimes you want just a simple servlet container - without all the other junk - that just goes. 
    This is where Winstone is best suited.</p>

  <p>The original goals in writing Winstone were:</p>
    <ul>
      <li>Supply fast, reliable servlet container functionality for a single webapp per server</li>
      <li>Keep the size of the core distribution jar as low as possible (currently 138KB)</li>
      <li>Keep configuration files to an absolute minimum, using command line options to 
        optionally override sensible compiled in defaults. </li>
      <li>Eventually compile with GCJ to make a 3-4Meg windows exe for local development/deployment 
        of servlets. This has not happened yet, because of some GCJ class loading problems.</li>
      <li>Optionally support JSP compilation using Apache's Jasper. (http://jakarta.apache.org)</li>
    </ul>

<h2><a name="whyCalled">Why is it called Winstone ?</a></h2>

  <p>The short version (because the long version is way too politically incorrect) is as follows: </p>

  <p>Winstone is the name of a rather large Jamaican man a friend of mine met one night, while 
    he was out clubbing in the Roppongi area of Tokyo. He (my friend) was a little 
    liquored up at the time, and when Winstone suggested they head to "this really cool club" 
    he knew, he didn't think anything was wrong. It wasn't until Winstone led him down a dark 
    stairwell and dropped his trousers that my friend clued in and ran like hell.</p>

  <p>It was too good a story to let die, so I named this project Winstone so that said friend 
    will continue to be reminded of it. Heheheh ....</p>

<h2><a name="license">License</a></h2>

  <p>The Web-App DTD files (everything in the src/javax/servlet/resources and 
    src/javax/servlet/jsp/resources folders) are covered by the licenses described 
    at the top of each file (usually as licensed by Sun Microsystems).</p>

  <p>All other files are covered by the GNU Public License, as described in LICENSE.txt.</p>

<h2><a name="authorContact">Contacting the Author</a></h2>

  <p>You can contact me through the Winstone development list at sourceforge 
    (winstone-devel AT lists DOT sourceforge DOT net).  If you have any general comments or questions 
    about Winstone please mail me on that list - I'll try to start a faq soon.</p>

  <p>I'm open to help from anyone who's willing to help me meet the above goals for Winstone.
    Just mail me at the list (winstone-devel AT lists DOT sourceforge DOT net)</p>

<h2><a name="using">Using Winstone</a></h2>

  <p>If you want to build from source code, you will need to download and install Apache Ant. The
    following instructions assume you have already installed Ant and have the ant shell script in
    your path (to get Ant, see http://ant.apache.org/).</p>

  <p>To build Winstone, unpack the tree:</p>

    &nbsp;&nbsp;<code>tar zxf winstone_src_v0.7.tar.gz</code>

  <p>Then build it:</p>

    &nbsp;&nbsp;<code>cd winstone/development</code><br/>
    &nbsp;&nbsp;<code>ant dist</code>

  <p>To run it:</p>

    &nbsp;&nbsp;<code>java -jar ../dist/winstone_v0.7.jar --webroot=&lt;location of webroot&gt; </code> (+ other options)

  <p> - OR - </p>

    &nbsp;&nbsp;<code>java -jar ../dist/winstone_v0.7.jar --warfile=&lt;location of warfile&gt;</code> (+ other options)

  <p>The winstone.jar file will be in the winstone/dist directory after the build is complete.</p>

<h2><a name="commandLine">Command-line options:</a></h2>

  <pre>
Syntax:
  java -jar winstone_v0.7.jar [--option=value] [--option=value] etc

Required options: either --webroot OR --warfile
   --webroot                = set document root folder.
   --warfile                = set location of warfile to extract from.

Other options:
   --javaHome               = Override the JAVA_HOME variable
   --toolsJar               = The location of tools.jar (default is JAVA_HOME/lib/tools.jar) 
   --config                 = load configuration properties from here(if supplied).
   --prefix                 = add this prefix to all URLs. (eg http://host/prefix/etc).
   --commonLibFolder        = folder for additional jar files. Default is ./lib
   --logfile                = redirect winstone log messages to this file
   --debug                  = set the level of debug msgs (1-9). Default is 5 (INFO level)

   --httpPort               = set the http listening port. -1 to disable, Default is 8080
   --httpListenAddress      = set the http listening address. Default is all interfaces
   --httpDoHostnameLookups  = enable host name lookups on http connections. Default is false
   --httpsPort              = set the https listening port. -1 to disable, Default is disabled
   --httpsListenAddress     = set the https listening address. Default is all interfaces
   --httpsDoHostnameLookups = enable host name lookups on https connections. Default is false
   --httpsKeyStore          = the location of the SSL KeyStore file. Default is ./winstone.ks
   --httpsKeyStorePassword  = the password for the SSL KeyStore file. Default is null
   --ajp13Port              = set the ajp13 listening port. -1 to disable, Default is 8009
   --ajp13ListenAddress     = set the ajp13 listening address. Default is all interfaces
   --controlPort            = set the shutdown/control port. -1 to disable, Default disabled

   --handlerCountStartup    = set the no of worker threads to spawn at startup. Default is 5
   --handlerCountMax        = set the max no of worker threads to allow. Default is 300
   --handlerCountMaxIdle    = set the max no of idle worker threads to allow. Default is 50

   --directoryListings      = enable directory lists (true/false). Default is true
   --useJasper              = enable jasper JSP handling (true/false). Default is false
   --useWinstoneClassLoader = enable WebApp classLoader (true/false). Default is true
   --useServletReloading    = enable servlet reloading (true/false). Default is false
   --useInvoker             = enable the servlet invoker (true/false). Default is true
   --invokerPrefix          = set the invoker prefix. Default is /servlet/
   --usage / --help         = show this message

Cluster options:
   --useCluster             = enable cluster support (true/false). Default is false
   --clusterNodes           = a list of node addresses (eg IP:ControlPort,IP:ControlPort,etc)

JNDI options:
   --useJNDI                 = enable JNDI support (true/false). Default is false
   --jndi.resource.&lt;name&gt;    = set the class to be used for the resource marked &lt;name&gt;
   --jndi.param.&lt;name&gt;.&lt;att&gt; = set an attribute &lt;att&gt; for the resource marked &lt;name&gt;

Security options:
   --realmClass                = Set the authentication realm class. Default = ArgumentsRealm
   --argumentsRealm.passwd.&lt;u&gt; = Password for user &lt;u&gt;. (for ArgumentsRealm)
   --argumentsRealm.roles.&lt;u&gt;  = Roles for user &lt;u&gt; (comma-separated) (for ArgumentsRealm)
   --fileRealm.configFile      = File containing users/passwds/roles. (for FileRealm)
</pre>

<h2><a name="configFile">Configuration file</a></h2>

  <p>You don't really need a config file, but sometimes it's handy to be able to use the same settings
    each time without running through the command history.</p>

  <p>Winstone looks for a config file <code>winstone.properties</code> in the current directory (or in the location 
    specified with --config) at startup. It loads the properties in this file, overrides them with any
    supplied command line properties, and then starts itself.</p>

  <p>This is just intended as a handy feature for people who want to cache regular startup options, rather
    than using batch files.</p>

<h2><a name="caveats">Caveats</a></h2>

  <p>As a result of the design goals, there are some things Winstone doesn't do</p>
  <ul>
    <li>Winstone only supports a single web application per server. This is a deliberate limitation,
      intended to reduce complexity and therefore size.</li>
    <li>There are now three connectors supplied with Winstone:
      <ol>
        <li>An internal HTTP connector - allows plain HTTP/1.1 connections only</li>
        <li>An internal HTTPS connector - allows HTTP/1.1 connections over SSL</li>
        <li>An AJP13 connector - allows connection to Apache/IIS/iPlanet, etc</li>
      </ol>
      While there is an internal HTTPS/SSL connector included, I recommend using 
      Apache 2.0 with the AJP13 connector (instructions below). It has way more configuration
      options than Winstone's connector does.</li>
    <li>HttpSession support is cookie-based only (no URL rewriting). URL rewriting introduces a lot of 
      unnecessary complex request body processing, and given that browser cookie support is common these
      days (and no-one I know uses URL rewriting), I plan not to implement this.</li>
    <li>The messages are all in English only. These have been updated to use resource 
      bundles, but no translations yet.</li>
  </ul>

<h2><a name="security">Security Warning</a></h2>

  <p>If you enable the controlPort, be aware that there is no password protection at all on this port. 
    Anyone who can get access to this port can stop or restart the server. I plan to 
    add some simple authentication to this at some point, but not just yet.</p>

  <p>The controlPort is disabled by default. If you choose not to enable it, the only way to shut
    Winstone down is to kill the process (either by Ctrl-C or kill command).</p>

<h2><a name="recent">Recent additions</a></h2>

  <p>New features in v0.6:</p>

  <ul>
    <li>Updated to <b>Servlet 2.4</b> specification compliance, although I haven't yet
      run Sun's Test Compatibility Kit on it - I'm still waiting for that. It works
      with all of the v2.4 webapps I've tried. The only caveat is that you will need
      Apache Xerces in the system classpath to make it work (see below).</li>
    <li>Updated to <b>JSP 2.0</b> specification compliance. This is the main cause
      for the blowout in size of the larger jar file, but it does result in much 
      simpler set up for Jasper (see below).</li>
    <li>Added a <b>command-line tool</b> for accessing control port options, such as 
      <b>shutdown</b> and <b>restart</b>. Restart is new to this version, and causes 
      a shutdown and redeploy from scratch.</li>
    <li>Added a <b>lib folder</b> for additional jars. This defaults to "lib" under the 
      current directory, with any jar or zip files in this folder being added to the 
      webapp classpath.</li>
    <li>Extensively tested with the <b>Apache Struts and JSTL frameworks</b>. This highlighted
      a number of bugs related to internationalisation I wouldn't have found otherwise.</li>
    <li>Many minor features such as <b>range downloads</b> on static resources, a <b>logfile</b>
      directive for writing log messages to a file, and many MANY performance enhancements and 
      bugfixes. See the TODO.txt file in the source distribution for a full list.</li>
    <li><b>Update: June 28, 2004</b> - Added <b>HTTPS</b> support to version v0.6.4</li>
  </ul>

  <p>New features in v0.5:</p>

  <ul>
    <li>Implemented <b>DIGEST</b> and <b>CERT</b> authentication methods. The CERT type is largely untested 
      (due to lack of A: access to certificates and B: knowledge of browser configuration for client 
      certificates) - if anyone wants to help with testing this, I'd appreciate it.</li>
    <li>Implemented simple <b>clustering</b> (ie sharing of sessions between multiple Winstone instances).
      See below for cluster configuration details.</li>
    <li>Implemented optional <b>JNDI</b> support. This is just a memory-based Context intended for storing 
      lookups on <code>&lt;env-entry&gt;</code> and <code>&lt;resource-ref&gt;</code> references, but 
      it also includes a pooling JDBC DataSource object .... it's funny how you don't realise how important some
      things are until you go without them ....</li>
    <li>The control port has been modified to be more useful. See below for usage instructions.</li>
    <li>The distribution jar is now available in two forms:
      <ol>
        <li><b>Complete version</b> (winstone.jar): This contains the complete winstone feature-set, 
          including AJP13 Apache connectors, Authentication/Realm support and Clustering support.</li>
        <li><b>Lite version</b> (winstone-lite.jar): This is the core winstone feature-set only,
          ie commonly used servlet features, as fast and reliable as possible, with unnecessary options 
          removed.</li>
      </ol>
    </li>
  </ul>

  <p>New features in v0.4:</p>

  <ul>
    <li>Implemented the <b>&lt;error-page&gt;</b> directive</li>
    <li>Added object pools for request/response objects for performance reasons</li>
    <li>The handler pools are now controllable via startup properties</li>
    <li><b>Servlet reloading</b> is now supported (optionally - include 
      <code>--useServletReloading=true</code> at startup)</li>
    <li>The initial <b>Authentication Model</b> is in place (see below for help). There are two base 
      classes that make it work: <code>AuthenticationRealm</code> and <code>AuthenticationHandler</code>. 
      Currently Argument-based and File-based realms (ie user/password details supplied via command-line args 
      or XML files) and HTTP BASIC and FORM authentication are implemented, but the others (DIGEST and 
     CERT authentication forms) will come soon.</li>
  </ul>

  <p>New features in v0.3:</p>

  <ul>
    <li>The request handler threads now use <b>monitors</b>, which allows them to exist beyond a single
      request/response cycle. The benefit here is performance - it removes a serious bottleneck.</li>
    <li><b>WAR files</b> are now supported via the --warfile attribute. If you specify a warfile in this 
      manner, it will be automatically extracted by the container to a temp directory, overwriting
      only files that are older than the archive date.</li>
    <li><b>Servlet attribute, session, and context listeners</b> (Servlet spec v2.3) are now fully supported. 
      The HttpSessionActivationListener class will be fully supported once the session transfer
      is implemented.</li>
    <li><b>Servlet Filters</b> (Servlet spec v2.3) are now fully supported.</li>
    <li>There is now an <b>AJP13 connector</b>, which means Winstone will now work behind Apache/IIS/etc
      using Tomcat's mod_jk. Try it out and see ... there's a section below on using the mod_jk connector.</li>
  </ul>

<h2><a name="xerces">Using Xerces as an XML parser (required for v2.4 webapps)</a></h2>

  <p>As part of the upgrade in the servlet specification, the v2.4 incarnation of the
    web.xml file is validated using XML Schema Documents (XSD) as opposed to Document Type
    Definitions (DTD). While I still have no idea why such a change was necessary - especially 
    given that DTD validation seems to be more than enough in this case - I did implement it. 
    Perhaps the people on the specification committee might want to give a thought to container 
    size next time round, as this one change multiplies the size of the distribution by five.</p>

  <p>Anyway, to use Xerces, you'll need to download the latest Xerces-J parser from 
    <a href="http://xml.apache.org/xerces2-j/">here</a>, and copy xercesImpl.jar and xml-apis.jar
    into the jre/lib/ext folder of your JDK. Putting them in the winstone/lib folder will not work,
    because they must be in the system classpath to override the JDK internal XML parser.</p>

  <p>Alternatively you can add these two files to your startup classpath, but you will have to 
    manually specify the Winstone startup class:</p>
    <pre>&nbsp;&nbsp;java -cp winstone.jar;xercesImpl.jar;xml-apis.jar winstone.Launcher --webroot=...</pre>
  

<h2><a name="jasper">JSPs (aka using with Jasper)</a></h2>

  <p>Winstone supports JSPs using Apache's Jasper JSP compiler. Thanks to a rather clever 
    design by the Jasper team, this was much less work than I expected - well done Jasper guys.</p>

  <p>Required steps:</p>
  <ol>
    <li>Add --useJasper to your startup command line, since
      JSPs are disabled by default</li>

    <li>
      <p>Both the v1.1 and v2.0 versions of Jasper are supported. In order to turn on JSP compilation
        in Winstone, you'll need to place the following jar files into the lib folder under the 
        current directory (or the folder identified by the --commonLibFolder directive).</p>
      <ul>
        <li><b>jasper-compiler.jar, jasper-runtime.jar, ant.jar</b> - 
           Not supplied with Winstone. You can get this from the standard Tomcat binary download location. 
           Just download the latest Tomcat, and copy these three files into the lib folder 
           for Winstone. They will be in the tomcat_home/common/lib folder.</li>

        <li><b>commons-logging-api.jar, commons-el.jar (Jasper 2 only)</b> - 
           These are required if you are using Jasper 2.0. You can get them from the 
           tomcat binary distribution or separately from the link below.</li>
      </ul>
    <p>All of these are available from the <a href="http://jakarta.apache.org/site/binindex.cgi">Jakarta download site</a></p>
    </li>
    <li>
      <p>You'll also need <b>tools.jar</b>, and this is handled a little differently. 
      The ant javac compile task needs this to turn the generated .java files into 
      .class files at runtime. You should already have this in the &lt;java_home&gt;/lib folder 
      of your jdk.</p>

      <p>There are two new startup arguments for Winstone --javaHome and --toolsJar. You 
      should only need to set --javaHome to make Jasper work properly. Your startup might
      look like this:</p>
      
      <pre>&nbsp;&nbsp;java -jar winstone.jar --useJasper \
                         --javaHome=c:\java\jdk1.4.2 \
                         --webroot=...</pre>
      <p>Additionally, you can specify the exact location of the toolsJar file like this:</p>
      <pre>&nbsp;&nbsp;java -jar winstone.jar --useJasper \
                         --javaHome=c:\java\jdk1.4.2 \
                         --toolsJar=c:\tools.jar \
                         --webroot=...</pre>
    </li>
  </ol>

<h2><a name="apache">Connecting to Apache</a></h2>

  <p>These instructions are for beginners: if you know your way around Apache and Tomcat, you'll know what's going on here.</p>

  <p>Download and install Apache for your platform (and obviously Winstone too), then follow these steps:</p>

  <ol>
    <li>Download mod_jk2.dll/so into the apache modules directory</li>
    <li>Add the following to the apache conf file (httpd.conf): 
<pre>
LoadModule jk2_module modules/mod_jk2.dll

&lt;Location "/&lt;Winstone Prefix&gt;/*"&gt;
  JkUriSet worker ajp13:localhost:8009 
&lt;/Location&gt;
</pre></li>
    <li>Create a new file called workers2.properties in the apache conf directory, with the following contents
<pre>
# only in the beginning. In production comment out
[logger.apache2]
level=DEBUG

# Example socket channel, override port and host.
[channel.socket:localhost:8009]
port=8009
host=127.0.0.1

# define the worker
[ajp13:localhost:8009]
channel=channel.socket:localhost:8009
</pre></li>
    <li>Start up Winstone and Apache and try connecting to the your webapp on the apache port, with the winstone 
      prefix. If it doesn't work, try looking at the apache error.log file for hints. If you get hex dumps, mail
      them to the winstone-devel list, together with any stack traces winstone generated.</li>
  </ol>

  <p>Please note this is not an optimal configuration for production uses. This is provided purely for those
    who need some help to get started. Read the mod_jk documentation with Tomcat for more detailed info.</p>

<h2><a name="authRealms">Using Authentication Realms</a></h2>

  <p>The process here is almost identical to that of Tomcat (I know this because I used the Tomcat examples
    webapp to develop against). There are two components - the web.xml component and selecting/configuring
    an AuthenticationRealm class.</p>

  <ul>
    <li>The web.xml part is the same for all webapps - you include the <code>&lt;security-constraint&gt;</code>
      and <code>&lt;login-config&gt;</code> elements as required, eg (from the Tomcat examples web.xml):
<pre>
&lt;security-constraint&gt;
  &lt;display-name&gt;Example Security Constraint&lt;/display-name&gt;
  &lt;web-resource-collection&gt;
    &lt;web-resource-name&gt;Protected Area&lt;/web-resource-name&gt;
    &lt;url-pattern&gt;/jsp/security/protected/*&lt;/url-pattern&gt;
    &lt;http-method&gt;DELETE&lt;/http-method&gt;
    &lt;http-method&gt;GET&lt;/http-method&gt;
    &lt;http-method&gt;POST&lt;/http-method&gt;
    &lt;http-method&gt;PUT&lt;/http-method&gt;
  &lt;/web-resource-collection&gt;
  &lt;auth-constraint&gt;
    &lt;role-name&gt;tomcat&lt;/role-name&gt;
    &lt;role-name&gt;role1&lt;/role-name&gt;
  &lt;/auth-constraint&gt;
&lt;/security-constraint&gt;

&lt;login-config&gt;
  &lt;auth-method&gt;FORM&lt;/auth-method&gt;
  &lt;realm-name&gt;Example Form-Based Authentication Area&lt;/realm-name&gt;
  &lt;form-login-config&gt;
    &lt;form-login-page&gt;/jsp/security/protected/login.jsp&lt;/form-login-page&gt;
    &lt;form-error-page&gt;/jsp/security/protected/error.jsp&lt;/form-error-page&gt;
  &lt;/form-login-config&gt;
&lt;/login-config&gt;
</pre></li>

    <li>The AuthenticationRealm part is Winstone specific. Here you currently have three options:
      <ol>
        <li><b>ArgumentsRealm:</b> Here you simply add additional command line args for each user's password and
          role list. Passwords are added with <code>--argumentsRealm.passwd.&lt;username&gt;=&lt;password&gt;</code>, 
          and roles are added with <code>--argumentsRealm.roles.&lt;username&gt;=&lt;role1&gt;,&lt;role2&gt;</code></li>
        <li><b>FileRealm:</b> This is the same as the Tomcat <code>tomcat-users.xml</code> file. 
          Pass in the command line arguments <code>--realmClass=winstone.realm.FileRealm 
          --fileRealm.configFile=&lt;filename&gt;</code>, and it should work exactly the way Tomcat does by default.</li>
        <li><b>Write your own:</b> You just have to extend the <code>winstone.AuthenticationRealm</code> class,
          and override the appropriate methods (as the File and Arguments Realms do), and specify the class name in
          <code>--realmClass</code>.</li>
      </ol>
    </li>
  </ul>

  <p>This component is left intentionally fairly simple, and relatively extracted. I'm planning to break the realm and
    authentication stuff into an optional jar later, since not many webapps I've seen use it.</p>

<h2><a name="cluster">Cluster support</a></h2>
  <p>It should be pointed out in the beginning that the Cluster support currently implemented in Winstone
    is actually just session sharing. If a request comes to a node in the cluster that doesn't recognise the
    session ID supplied, that node simply asks the others "Do you know this session ?". If one does know it, 
    it transfers the session to the requesting node, and the requesting node carries on as if it had always
    had the session in the first place.</p>

  <p>If a specific node in the cluster goes offline, so do all the sessions that it was holding. There is no
    active "push" of sessions to other nodes, so as far as resilience to failure goes, this cluster is 
    fairly weak. The clustering provided here is meant to allow a dumb load balancer to redirect requests
    randomly across a cluster of Winstone instances without requiring it to be "session sticky".</p>

  <p>That said, the configuration is fairly simple. The only information you need is the IP address and control
    port of at least one other active node in the cluster. Once you have that, add the following options to
    the command line startup:</p>
<pre>
java -jar winstone.jar ...&lt; other options &gt; ... \
                       --controlPort=&lt;myControlPort&gt; \
                       --useCluster \
                       --clusterNodes=&lt;IP1:controlPort1&gt;
</pre>
    <p>where IP1 is the IP address of the other node in the cluster, and myControlPort and controlPort1 are the port
    numbers to use for the control ports of this instance and the other node respectively. Note that it is necessary
    to actively set the controlPort on this instance, since it is disabled by default.</p>

  <p>You would likewise set up the other instance with reciprocal options (ie changing the IPs and controlPort values
    appropriately.</p>

  <p>NOTE: There are some additional requirements on your web application for Clustering of sessions to be 
    successful.</p>
    <ol>
      <li>You need to include the <b>&lt;distributable/&gt;</b> element in your web.xml file. This tells Winstone that
        your webapp is programmed correctly to support clustering. If this is missing, clustering will be disabled.</li>
      <li>Any objects you add to the session must implement <b>java.io.Serializable</b>. This is required because
        Winstone serializes the objects in the session over the controlPort to other nodes, and reconstructs the
        serialized session at the destination. If you try to put a non-serializable object into the session, 
        Winstone will throw an exception reminding you to make all session objects serializable.</li>
    </ol>

<h2><a name="controlPort">Control port functions/protocol</a></h2>

  <p>From v0.5, the behaviour of the control port changes slightly. Due to increased usage of the control port
    by the clustering function, a rudimentary protocol has been added. </p>

  <p>The protocol is very simple. The first byte sent to the server is a flag indicating what type of request
    is being issued. Beyond that the protocol varies for each request type, but the request type flag options
    are listed below:</p>
    <ul>
      <li><b>0 (ASCII 48)</b> = shutdown</li>
      <li><b>1 (ASCII 49)</b> = request search for a session</li>
      <li><b>2 (ASCII 50)</b> = request list of currently connected cluster nodes</li>
      <li><b>3 (ASCII 51)</b> = cluster node heartbeat</li>
      <li><b>4 (ASCII 52)</b> = request reload of web application context</li>
    </ul>

  <p>Obviously, unless you're planning to write your own cluster extensions, the only two you will be interested
   in are the shutdown and reload options. Luckily there is a wrapper class for accessing these functions, named
   <code>winstone.tools.WinstoneControl</code>. Try the following to get a usage statement:</p>
     <pre>&nbsp;&nbsp;java -cp winstone.jar winstone.tools.WinstoneControl</pre>
  

<h2><a name="jndi">JNDI support</a></h2>

  <p>I know that in the introduction I said that Winstone was only going to support the core servlet APIs, but
    I've since discovered that most people use just a little more than the core servlet API offers. For 
    example, some people use just a JNDI JavaMail session to send administrator error mails, while others want
    to offer a simple servlet over SSL (and hence need Apache), still others use just a JNDI DataSource
    to keep a reference to the connection pool.</p>

  <p>For this reason I've included a really basic optional JNDI service within Winstone. For the moment,
    it supports simple operations (such as bind, lookup, rebind, etc) and allows you to store references to 
    environment variables (drawn from the env-entry elements in web.xml and/or command line arguments).</p>

  <p>NOTE: JNDI support is disabled by default. It must be enabled using <code>--useJNDI=true</code></p>

  <p>Configuration can be done in two ways:</p>
    <ul>
      <li><b>&lt;env-entry&gt; elements</b> - This is the standard way to add simple objects, such as
        sql strings or configuration integers/strings. For example:
<pre>
  &lt;env-entry&gt;
    &lt;env-entry-name&gt;test/hello&lt;/env-entry-name&gt;
    &lt;env-entry-type&gt;java.lang.Integer&lt;/env-entry-type&gt;
    &lt;env-entry-value&gt;45&lt;/env-entry-value&gt;
  &lt;/env-entry&gt;
</pre></li>
      <li><b>Command line arguments</b> - This is for more complex objects that require attributes
        to be created (JDBC DataSources for example). The syntax here involves adding a clause of the
        kind <code>--jndi.resource.&lt;resName&gt;=&lt;className&gt;</code> for each object to create,
        followed by <code>--jndi.param.&lt;resName&gt;.&lt;attName&gt;=&lt;attValue&gt;</code> for each
        attribute required. For example:
<pre>
java -jar winstone.jar ...&lt; other options &gt; ... \
                        --useJNDI=true \
                        --jndi.resource.test=java.lang.Float \
                        --jndi.param.test.value=45.56
</pre></li>
    </ul>
  
 
  <p>Additionally, it includes a JDBC DataSource object which can be used as a wrapper around normal JDBC 
    drivers. This is fairly simple for now, but it meets the requirements I mentioned above. Options are as
    follows:</p>
    <ol>
      <li><b>url (REQUIRED)</b> - JDBC URL (<code>jdbc:mysql://db.widgets.com/db</code>)</li>
      <li><b>driverClassName (REQUIRED)</b> - JDBC Driver name (eg <code>com.mysql.jdbc.Driver</code>)</li>
      <li><b>username</b> - username for database authentication</li>
      <li><b>password</b> - password for database authentication</li>
      <li><b>maxConnections</b> - Maximum number of connections allowed in the pool. Default is 20</li>
      <li><b>maxIdle</b> - Maximum number of idle connections allowed in the pool. Default is 10</li>
      <li><b>startConnections</b> - The number of connections to open the pool with. Deafault is 2</li>
    </ol>

  <p>For example to create a DataSource object at the JNDI location java:/comp/env/jdbc/connPool, use the 
    following command line (or config file) options:</p>
<pre>
java -jar winstone.jar ...&lt; other options &gt; ... \
                        --useJNDI=true \
                        --jndi.resource.jdbc/connPool=javax.sql.DataSource \
                        --jndi.param.jdbc/connPool.url=jdbc:mysql://db.widgets.com/db \
                        --jndi.param.jdbc/connPool.driverClassName=com.mysql.jdbc.Driver \
                        --jndi.param.jdbc/connPool.username=foo \
                        --jndi.param.jdbc/connPool.password=bar
</pre>

<h2><a name="https">HTTPS support</a></h2>

  <p>Somebody asked me to add HTTPS support, using the JDK 1.4 SSL socket classes, and
    so I decided to give it a try. It was a lot easier than expected - the API was really
    nice to use. Unfortunately the hard work seems to be in the configuration, rather
    than the programming.</p>
    
  <p>I recommend using a shareware tool called KeyStore Explorer, available 
    <a href="http://www.lazgosoftware.com/kse/index.html">here</a>. It's much easier than
    all that messy CLI stuff.</p>  
    
  <p>The steps are basically as follows:</p>
  
  <ol>
    <li>Create an empty keystore of type JKS</li>
    <li>Generate a key pair (Tools -&gt; Generate Key Pair). I chose RSA 2048 bit, and used
      "MD5 with RSA" for the algorithm. Set a password and remember it.</li>
    <li>Generate a CSR (right click, Generate CSR).</li>
    <li>Send the CSR to a Certifying Authority (CA) for processing. I used FreeSSL.com,
      because it was only US$39 per year.</li>
    <li>Once you get the approved certificate back, import it into the key store you
      were using (Tools -&gt; import CA reply). You should now have only a
      key pair and a certificate. Save the key store, using the same password you used
      before.</li>
    <li>Start winstone with the following command:
      <pre>java -jar winstone.jar --webroot=&lt;webroot&gt;
                       --httpsPort=443 
                       --httpsKeyStore=&lt;keystore file&gt; 
                       --httpsKeyStorePassword=&lt;password&gt;</pre>  
    </li>
    <li>Set your hosts file (/etc/hosts or c:/Winnt/system32/drivers/etc/hosts) to 
      point the name on your certificate to 127.0.0.1, then try to browse to 
      https://(name on certificate)/</li>
  </ol>

<h2><a name="gcj">Compiling with GCJ</a></h2>

  <p>I've had a little bit of success with this recently. Under the gcj folder in the source
    distribution there is a Makefile that I used to build Winstone to a native binary. It worked
    quite well - and to my naked eye, looked like lightning for static pages - except for 
    one problem: class loading.</p>

  <p>The problem is this: When you call "Class.forName(className)", the effect should be the 
    same as calling "Class.forName(className, true, Thread.currentThread().getContextClassLoader())", and 
    the short answer is that in recent GCJ versions, it's not.</p>

  <p>Recent GCJ versions use a "bogus" method to find the current class loader (their words 
    not mine). Basically GCJ generates a stack trace and walks back over it, trying to find a 
    class loader within recent memory. If none is found, it uses the system class loader.</p>

  <p>In most cases this is fine, but in a servlet container this is no good, because unless you
    have a webapp that has no WEB-INF/lib and WEB-INF/classes folders, you need to use a class
    loader other than the system classloader.</p>

  <p>One possible solution is to compile the webapp classes and Winstone into native binary format.
    This works except that if the servlet container tries to use another class loader anyway, you
    still have problems with which loader loaded which classes.</p>

  <p>To get around this, I have included an option "--useWinstoneClassLoader=false". This allows
    you to disable the webapp class loader, and operate entirely with a single class loader. This
    works ok for servlet-only environments, but it seems Jasper uses it's own classloader, so 
    you may still have problems in jsp + GCJ-compiled-Winstone environments.</p>
      </td>
    </tr>
  </table>
  </center>
  <hr width="90%" size="1" noshade="noshade"/>
  <center>
    <a href="http://sourceforge.net"><img src="http://sourceforge.net/sflogo.php?group_id=98922&amp;type=5" width="210" height="62" border="0" alt="SourceForge.net Logo" /></a>
    &nbsp;&nbsp;
    <a href="http://www.jars.com"><img src="http://www.jars.com/images/java_registered.gif" border="0" alt="Jars Registered"/></a>
    <a href="http://www.java.net"><img src="http://today.java.net/images/javanet_button_170.gif" border="0" alt="Java.net Linked Project"/></a>

  </center>
</body>
</html>